---
title: "Sentencing Data Exploration"
author: "Ki Hyun"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}
library(tidyverse)
library(sf)
library(janitor)
library(ggiraph)
library(knitr)
knitr::opts_chunk$set(echo = FALSE)
```

```{r data_cleaning, include=FALSE}
sentencing <- readRDS("data/hxmisd9919_request.RDS")
```

```{r basic_helpers}
recent.five <- sentencing %>% 
  filter(SENTDATE > "20150000")
```

```{r map_helper}
nc_counties <- st_read(system.file("shape/nc.shp", package = "sf"), 
                       quiet = T) %>% 
  clean_names()

county_code <- nc_counties %>% 
  st_drop_geometry() %>% 
  arrange(name) %>%
  select(name) 
  
county_code$code <- map_chr(0:99, ~ case_when(
    . == 0 ~ "000",
    . < 10 ~ str_c("0", as.character(10 * .)),
    TRUE ~ as.character(10 * .)
  ))

map_summary <- function(x, d){
  v <- county_code %>% 
    filter(name == x) %>% 
    .[["code"]]
  
  d %>% 
    filter(COUNTY == v) %>% 
    summarise(
      "Total Convicted" = as.character(n()),
      "Guilty Pleas" = paste0(round(sum(newdisp == 1)/n() * 100, 2), "%"),
      "Felony Cases" = paste0(round(sum(chrgtype == 1)/n() * 100, 2), "%"),
      "Misdemeanor Cases" = paste0(round(sum(chrgtype == 2)/n() * 100, 2), "%"),
      White = paste0(round(sum(race == "W")/n() * 100, 2), "%"),
      Black = paste0(round(sum(race == "B")/n() * 100, 2), "%"),
      Hispanic = paste0(round(sum(race == "H")/n() * 100, 2), "%"),
      Asian = paste0(round(sum(race == "A")/n() * 100, 2), "%"),
      Other = paste0(round(sum(race %in% c("O", "U", "I"))/n() * 100, 2), "%")
    )
}

tooltip_output <- function(x, d, f){
  temp <- f(x, d)
  
  v <- colnames(temp)
  
  str_c(x, "\n", 
        str_c(map_chr(v, ~ paste0(., ": ", temp[[.]], "\n")), 
              collapse = ""))
}
```

## North Carolina Sentencing Data

```{r all_data_setting}
dataf.1 <- sentencing

# felony
felony.1 <- dataf.1 %>% 
  filter(chrgtype == 1)

# misdemeanor
misdemeanor.1 <- dataf.1 %>% 
  filter(chrgtype == 2)

# durham data
durham.1 <- dataf.1 %>% 
  filter(COUNTY == "310")
```

```{r all_general_map}
nc_counties$descript <- nc_counties %>% 
  st_drop_geometry() %>% 
  .[["name"]] %>% 
  sapply(., tooltip_output, d = dataf.1, f = map_summary)

p_1 <- ggplot(nc_counties, aes(fill = name)) +
  geom_sf_interactive(aes(tooltip = descript), show.legend = FALSE) +
  labs(subtitle = "1999 - 2019") +
  theme_void(base_size = 14)

girafe(ggobj = p_1)
```

```{r recent_data_setting}
dataf.2 <- recent.five

# felony
felony.2 <- dataf.2 %>% 
  filter(chrgtype == 1)

# misdemeanor
misdemeanor.2 <- dataf.2 %>% 
  filter(chrgtype == 2)

# durham data
durham.2 <- dataf.2 %>% 
  filter(COUNTY == "310")
```

```{r recent_general_map}
nc_counties$descript <- nc_counties %>% 
  st_drop_geometry() %>% 
  .[["name"]] %>% 
  sapply(., tooltip_output, d = dataf.2, f = map_summary)

p_2 <- ggplot(nc_counties, aes(fill = name)) +
  geom_sf_interactive(aes(tooltip = descript), show.legend = FALSE) +
  labs(subtitle = "2015 - 2019") +
  theme_void(base_size = 14)

girafe(ggobj = p_2)
```